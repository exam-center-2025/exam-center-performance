import{D as g,E as ke,h as d,i as O,p as P}from"./_plugin-vue_export-helper-B8S04SUJ.js";const f={async startTest(i){return await g.post("/tests/start",i)},async getTestStatus(i){return await g.get(`/tests/${i}/result`)},async getTestResults(i){return await g.get(`/tests/${i}/results`)},async stopTest(i){return await g.post(`/tests/${i}/stop`)},async deleteTest(i){return await g.delete(`/tests/${i}`)},async getAllTests(){return await g.get("/tests")},async getPlans(){return await g.get("/plans")},async getPlanGroups(i){return await g.get(`/plans/${i}/groups`)},async checkDatabaseHealth(){return await g.get("/health/database")},async getRealtimeMetrics(i){return await g.get(`/tests/${i}/metrics/realtime`)},async getHistoricalMetrics(i,e,t){return await g.get(`/tests/${i}/metrics/history`,{params:{startTime:e,endTime:t}})},async getTestMetricsHistory(i,e=300){return await g.get(`/tests/${i}/metrics`,{params:{maxPoints:e}})},async getTestLogs(i,e=100){return await g.get(`/tests/${i}/logs`,{params:{count:e}})},async getTestDetails(i){return await g.get(`/tests/${i}`)},async getTestConfiguration(i){return await g.get(`/tests/${i}/config`)},async getTestHistory(i={}){return await g.get("/tests/history",{params:i})},async getQuickStats(){return await g.get("/stats")},async getSystemHealth(){return await g.get("/system/health")},async exportResults(i={}){return await g.get("/tests/export",{params:i,responseType:"blob"})}},Ne=ke("performance",()=>{const i=d([]),e=d(null),t=d([]),s=d(null),o=d(!1),r=d(null),l=d([]),c=d({todayTests:0,avgSuccessRate:0,avgTps:0,avgResponseTime:0,activeTestsCount:0}),h=d({serverCpu:0,serverMemory:0,dbStatus:"unknown",wsStatus:"unknown",activeSessions:0,lastUpdated:null}),m=d({dateRange:{start:null,end:null},status:"all",planId:null,searchText:"",sortBy:"startTime",sortOrder:"desc"}),_=d({tps:0,avgResponseTime:0,activeUsers:0,errorRate:0,errorCount:0,totalRequests:0,timestamp:null}),H=d([]),M=d(300),k=d({}),N=d(new Map),B=d({status:"UNKNOWN",message:"",progress:0,startTime:null,endTime:null}),E=d([]),x=d(100),D=d({testName:"",planId:null,maxUsers:100,rampUpSeconds:60,testDurationSeconds:300,runType:"TEST",scenario:"NORMAL_USER"}),R=O(()=>i.value.filter(n=>n.status==="RUNNING")),G=O(()=>i.value.filter(n=>n.status==="COMPLETED")),z=O(()=>{var n;return((n=e.value)==null?void 0:n.status)==="RUNNING"}),K=O(()=>(n,a)=>{const u=k.value[n];return u&&u[a]||0}),q=O(()=>n=>k.value[n]||{});async function Q(){try{o.value=!0,r.value=null;const n=await f.getPlans();t.value=n||[]}catch(n){r.value=n.message,console.error("Failed to load plans:",n),t.value=[]}finally{o.value=!1}}async function X(){try{o.value=!0,r.value=null;const n=await f.getAllTests(),a=R.value.length;i.value=n||[],console.log("loadTests completed:",{totalTests:i.value.length,previousActiveTests:a,currentActiveTests:R.value.length,runningTests:i.value.filter(u=>u.status==="RUNNING").map(u=>({id:u.testId,status:u.status}))})}catch(n){r.value=n.message,console.error("Failed to load tests:",n),i.value=[]}finally{o.value=!1}}async function J(n=D.value){try{o.value=!0,r.value=null;const a=await f.startTest(n);return e.value=a,i.value.unshift(a),a}catch(a){throw r.value=a.message,console.error("Failed to start test:",a),a}finally{o.value=!1}}async function Y(n){var a;try{o.value=!0,r.value=null,await f.stopTest(n),((a=e.value)==null?void 0:a.id)===n&&(e.value.status="STOPPED");const u=i.value.find(y=>y.id===n);u&&(u.status="STOPPED")}catch(u){throw r.value=u.message,console.error("Failed to stop test:",u),u}finally{o.value=!1}}async function Z(n){try{return o.value=!0,r.value=null,await f.getTestResults(n)}catch(a){throw r.value=a.message,console.error("Failed to get test results:",a),a}finally{o.value=!1}}function ee(n){D.value={...D.value,...n}}function te(){D.value={testName:"",planId:null,maxUsers:100,rampUpSeconds:60,testDurationSeconds:300,runType:"TEST",scenario:"NORMAL_USER"}}function se(n){_.value={...n,timestamp:Date.now()},H.value.push({...n,timestamp:Date.now()}),H.value.length>M.value&&H.value.shift()}function ne(n,a){const u={...k.value,[n]:{...a,lastUpdated:Date.now()}};k.value=u}function ie(n){const a={...k.value};delete a[n],k.value=a,console.log(`Store: Cleared metrics for test ${n}`)}function oe(){k.value={},console.log("Store: Cleared all test metrics")}function re(n,a){N.value.set(n,a),console.log(`Store: Registered subscription for test ${n}`)}function ae(n){const a=N.value.get(n);a&&(typeof a.unsubscribe=="function"&&a.unsubscribe(),N.value.delete(n),console.log(`Store: Unregistered subscription for test ${n}`))}function ce(n){return N.value.has(n)}function $(n){B.value={...B.value,...n}}function le(n){E.value.unshift({...n,id:Date.now()+Math.random(),timestamp:n.timestamp||Date.now()}),E.value.length>x.value&&(E.value=E.value.slice(0,x.value))}function he(){_.value={tps:0,avgResponseTime:0,activeUsers:0,errorRate:0,errorCount:0,totalRequests:0,timestamp:null},H.value=[],B.value={status:"UNKNOWN",message:"",progress:0,startTime:null,endTime:null},E.value=[]}function ue(n=5){const a=Date.now()-n*60*1e3;return H.value.filter(u=>u.timestamp>a)}async function de(n={}){try{o.value=!0,r.value=null;const a=await f.getTestHistory(n);return l.value=(a==null?void 0:a.data)||a||[],a}catch(a){return r.value=a.message,console.error("Failed to load test history:",a),l.value=[],{data:[]}}finally{o.value=!1}}async function me(){try{const n=await f.getQuickStats();c.value={todayTests:n.totalTests||0,avgSuccessRate:(n.successRate||0)/100,avgTps:n.avgTps||0,avgResponseTime:n.avgResponseTime||0,activeTestsCount:n.activeTests||0}}catch(n){console.error("Failed to load quick stats:",n)}}async function ge(){try{const n=await f.getSystemHealth();h.value={serverCpu:n.serverCpu||0,serverMemory:n.serverMemory||0,dbStatus:n.dbStatus||"unknown",wsStatus:n.wsStatus||"unknown",activeSessions:n.activeSessions||0,lastUpdated:Date.now()}}catch(n){console.error("Failed to load system health:",n)}}async function pe(n={}){try{o.value=!0;const a=await f.exportResults(n),u=window.URL.createObjectURL(a),y=document.createElement("a");y.href=u,y.download=`test-results-${Date.now()}.csv`,document.body.appendChild(y),y.click(),window.URL.revokeObjectURL(u),document.body.removeChild(y)}catch(a){throw r.value=a.message,console.error("Failed to export results:",a),a}finally{o.value=!1}}function be(n){m.value={...m.value,...n}}function _e(){m.value={dateRange:{start:null,end:null},status:"all",planId:null,searchText:"",sortBy:"startTime",sortOrder:"desc"}}function ye(n){h.value={...h.value,...n,lastUpdated:Date.now()}}function fe(){return console.log("Store Debug State:",{testsCount:i.value.length,activeTestsCount:R.value.length,testsWithStatus:i.value.map(n=>({id:n.testId,status:n.status})),activeTestsDetails:R.value.map(n=>({id:n.testId,status:n.status}))}),{tests:i.value,activeTests:R.value}}return{tests:i,currentTest:e,plans:t,selectedPlan:s,loading:o,error:r,testConfig:D,testHistory:l,quickStats:c,systemHealth:h,testFilters:m,currentMetrics:_,metricsHistory:H,maxHistorySize:M,testStatus:B,logEntries:E,maxLogEntries:x,testMetrics:k,metricsSubscriptions:N,activeTests:R,completedTests:G,isTestRunning:z,getTestMetric:K,getTestMetrics:q,loadPlans:Q,loadTests:X,startTest:J,stopTest:Y,updateTestStatus:$,getTestResults:Z,setTestConfig:ee,resetTestConfig:te,loadTestHistory:de,loadQuickStats:me,loadSystemHealth:ge,exportTestResults:pe,setTestFilters:be,resetTestFilters:_e,updateSystemHealth:ye,updateMetrics:se,updateTestStatus:$,addLogEntry:le,clearMonitoringData:he,getRecentMetricsHistory:ue,updateTestMetrics:ne,clearTestMetrics:ie,clearAllTestMetrics:oe,registerMetricsSubscription:re,unregisterMetricsSubscription:ae,hasMetricsSubscription:ce,debugStoreState:fe}});function we(i,e){i.terminate=function(){const t=()=>{};this.onerror=t,this.onmessage=t,this.onopen=t;const s=new Date,o=Math.random().toString().substring(2,8),r=this.onclose;this.onclose=l=>{const c=new Date().getTime()-s.getTime();e(`Discarded socket (#${o})  closed after ${c}ms, with code/reason: ${l.code}/${l.reason}`)},this.close(),r==null||r.call(i,{code:4001,reason:`Quick discarding socket (#${o}) without waiting for the shutdown sequence.`,wasClean:!1})}}const I={LF:`
`,NULL:"\0"};class S{get body(){return!this._body&&this.isBinaryBody&&(this._body=new TextDecoder().decode(this._binaryBody)),this._body||""}get binaryBody(){return!this._binaryBody&&!this.isBinaryBody&&(this._binaryBody=new TextEncoder().encode(this._body)),this._binaryBody}constructor(e){const{command:t,headers:s,body:o,binaryBody:r,escapeHeaderValues:l,skipContentLengthHeader:c}=e;this.command=t,this.headers=Object.assign({},s||{}),r?(this._binaryBody=r,this.isBinaryBody=!0):(this._body=o||"",this.isBinaryBody=!1),this.escapeHeaderValues=l||!1,this.skipContentLengthHeader=c||!1}static fromRawFrame(e,t){const s={},o=r=>r.replace(/^\s+|\s+$/g,"");for(const r of e.headers.reverse()){r.indexOf(":");const l=o(r[0]);let c=o(r[1]);t&&e.command!=="CONNECT"&&e.command!=="CONNECTED"&&(c=S.hdrValueUnEscape(c)),s[l]=c}return new S({command:e.command,headers:s,binaryBody:e.binaryBody,escapeHeaderValues:t})}toString(){return this.serializeCmdAndHeaders()}serialize(){const e=this.serializeCmdAndHeaders();return this.isBinaryBody?S.toUnit8Array(e,this._binaryBody).buffer:e+this._body+I.NULL}serializeCmdAndHeaders(){const e=[this.command];this.skipContentLengthHeader&&delete this.headers["content-length"];for(const t of Object.keys(this.headers||{})){const s=this.headers[t];this.escapeHeaderValues&&this.command!=="CONNECT"&&this.command!=="CONNECTED"?e.push(`${t}:${S.hdrValueEscape(`${s}`)}`):e.push(`${t}:${s}`)}return(this.isBinaryBody||!this.isBodyEmpty()&&!this.skipContentLengthHeader)&&e.push(`content-length:${this.bodyLength()}`),e.join(I.LF)+I.LF+I.LF}isBodyEmpty(){return this.bodyLength()===0}bodyLength(){const e=this.binaryBody;return e?e.length:0}static sizeOfUTF8(e){return e?new TextEncoder().encode(e).length:0}static toUnit8Array(e,t){const s=new TextEncoder().encode(e),o=new Uint8Array([0]),r=new Uint8Array(s.length+t.length+o.length);return r.set(s),r.set(t,s.length),r.set(o,s.length+t.length),r}static marshall(e){return new S(e).serialize()}static hdrValueEscape(e){return e.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/:/g,"\\c")}static hdrValueUnEscape(e){return e.replace(/\\r/g,"\r").replace(/\\n/g,`
`).replace(/\\c/g,":").replace(/\\\\/g,"\\")}}const j=0,L=10,A=13,Te=58;class Se{constructor(e,t){this.onFrame=e,this.onIncomingPing=t,this._encoder=new TextEncoder,this._decoder=new TextDecoder,this._token=[],this._initState()}parseChunk(e,t=!1){let s;if(typeof e=="string"?s=this._encoder.encode(e):s=new Uint8Array(e),t&&s[s.length-1]!==0){const o=new Uint8Array(s.length+1);o.set(s,0),o[s.length]=0,s=o}for(let o=0;o<s.length;o++){const r=s[o];this._onByte(r)}}_collectFrame(e){if(e!==j&&e!==A){if(e===L){this.onIncomingPing();return}this._onByte=this._collectCommand,this._reinjectByte(e)}}_collectCommand(e){if(e!==A){if(e===L){this._results.command=this._consumeTokenAsUTF8(),this._onByte=this._collectHeaders;return}this._consumeByte(e)}}_collectHeaders(e){if(e!==A){if(e===L){this._setupCollectBody();return}this._onByte=this._collectHeaderKey,this._reinjectByte(e)}}_reinjectByte(e){this._onByte(e)}_collectHeaderKey(e){if(e===Te){this._headerKey=this._consumeTokenAsUTF8(),this._onByte=this._collectHeaderValue;return}this._consumeByte(e)}_collectHeaderValue(e){if(e!==A){if(e===L){this._results.headers.push([this._headerKey,this._consumeTokenAsUTF8()]),this._headerKey=void 0,this._onByte=this._collectHeaders;return}this._consumeByte(e)}}_setupCollectBody(){const e=this._results.headers.filter(t=>t[0]==="content-length")[0];e?(this._bodyBytesRemaining=parseInt(e[1],10),this._onByte=this._collectBodyFixedSize):this._onByte=this._collectBodyNullTerminated}_collectBodyNullTerminated(e){if(e===j){this._retrievedBody();return}this._consumeByte(e)}_collectBodyFixedSize(e){if(this._bodyBytesRemaining--===0){this._retrievedBody();return}this._consumeByte(e)}_retrievedBody(){this._results.binaryBody=this._consumeTokenAsRaw();try{this.onFrame(this._results)}catch(e){console.log("Ignoring an exception thrown by a frame handler. Original exception: ",e)}this._initState()}_consumeByte(e){this._token.push(e)}_consumeTokenAsUTF8(){return this._decoder.decode(this._consumeTokenAsRaw())}_consumeTokenAsRaw(){const e=new Uint8Array(this._token);return this._token=[],e}_initState(){this._results={command:void 0,headers:[],binaryBody:void 0},this._token=[],this._headerKey=void 0,this._onByte=this._collectFrame}}var C;(function(i){i[i.CONNECTING=0]="CONNECTING",i[i.OPEN=1]="OPEN",i[i.CLOSING=2]="CLOSING",i[i.CLOSED=3]="CLOSED"})(C||(C={}));var b;(function(i){i[i.ACTIVE=0]="ACTIVE",i[i.DEACTIVATING=1]="DEACTIVATING",i[i.INACTIVE=2]="INACTIVE"})(b||(b={}));var V;(function(i){i[i.LINEAR=0]="LINEAR",i[i.EXPONENTIAL=1]="EXPONENTIAL"})(V||(V={}));var U;(function(i){i.Interval="interval",i.Worker="worker"})(U||(U={}));class Ce{constructor(e,t=U.Interval,s){this._interval=e,this._strategy=t,this._debug=s,this._workerScript=`
    var startTime = Date.now();
    setInterval(function() {
        self.postMessage(Date.now() - startTime);
    }, ${this._interval});
  `}start(e){this.stop(),this.shouldUseWorker()?this.runWorker(e):this.runInterval(e)}stop(){this.disposeWorker(),this.disposeInterval()}shouldUseWorker(){return typeof Worker<"u"&&this._strategy===U.Worker}runWorker(e){this._debug("Using runWorker for outgoing pings"),this._worker||(this._worker=new Worker(URL.createObjectURL(new Blob([this._workerScript],{type:"text/javascript"}))),this._worker.onmessage=t=>e(t.data))}runInterval(e){if(this._debug("Using runInterval for outgoing pings"),!this._timer){const t=Date.now();this._timer=setInterval(()=>{e(Date.now()-t)},this._interval)}}disposeWorker(){this._worker&&(this._worker.terminate(),delete this._worker,this._debug("Outgoing ping disposeWorker"))}disposeInterval(){this._timer&&(clearInterval(this._timer),delete this._timer,this._debug("Outgoing ping disposeInterval"))}}class p{constructor(e){this.versions=e}supportedVersions(){return this.versions.join(",")}protocolVersions(){return this.versions.map(e=>`v${e.replace(".","")}.stomp`)}}p.V1_0="1.0";p.V1_1="1.1";p.V1_2="1.2";p.default=new p([p.V1_2,p.V1_1,p.V1_0]);class He{get connectedVersion(){return this._connectedVersion}get connected(){return this._connected}constructor(e,t,s){this._client=e,this._webSocket=t,this._connected=!1,this._serverFrameHandlers={CONNECTED:o=>{this.debug(`connected to server ${o.headers.server}`),this._connected=!0,this._connectedVersion=o.headers.version,this._connectedVersion===p.V1_2&&(this._escapeHeaderValues=!0),this._setupHeartbeat(o.headers),this.onConnect(o)},MESSAGE:o=>{const r=o.headers.subscription,l=this._subscriptions[r]||this.onUnhandledMessage,c=o,h=this,m=this._connectedVersion===p.V1_2?c.headers.ack:c.headers["message-id"];c.ack=(_={})=>h.ack(m,r,_),c.nack=(_={})=>h.nack(m,r,_),l(c)},RECEIPT:o=>{const r=this._receiptWatchers[o.headers["receipt-id"]];r?(r(o),delete this._receiptWatchers[o.headers["receipt-id"]]):this.onUnhandledReceipt(o)},ERROR:o=>{this.onStompError(o)}},this._counter=0,this._subscriptions={},this._receiptWatchers={},this._partialData="",this._escapeHeaderValues=!1,this._lastServerActivityTS=Date.now(),this.debug=s.debug,this.stompVersions=s.stompVersions,this.connectHeaders=s.connectHeaders,this.disconnectHeaders=s.disconnectHeaders,this.heartbeatIncoming=s.heartbeatIncoming,this.heartbeatOutgoing=s.heartbeatOutgoing,this.splitLargeFrames=s.splitLargeFrames,this.maxWebSocketChunkSize=s.maxWebSocketChunkSize,this.forceBinaryWSFrames=s.forceBinaryWSFrames,this.logRawCommunication=s.logRawCommunication,this.appendMissingNULLonIncoming=s.appendMissingNULLonIncoming,this.discardWebsocketOnCommFailure=s.discardWebsocketOnCommFailure,this.onConnect=s.onConnect,this.onDisconnect=s.onDisconnect,this.onStompError=s.onStompError,this.onWebSocketClose=s.onWebSocketClose,this.onWebSocketError=s.onWebSocketError,this.onUnhandledMessage=s.onUnhandledMessage,this.onUnhandledReceipt=s.onUnhandledReceipt,this.onUnhandledFrame=s.onUnhandledFrame}start(){const e=new Se(t=>{const s=S.fromRawFrame(t,this._escapeHeaderValues);this.logRawCommunication||this.debug(`<<< ${s}`),(this._serverFrameHandlers[s.command]||this.onUnhandledFrame)(s)},()=>{this.debug("<<< PONG")});this._webSocket.onmessage=t=>{if(this.debug("Received data"),this._lastServerActivityTS=Date.now(),this.logRawCommunication){const s=t.data instanceof ArrayBuffer?new TextDecoder().decode(t.data):t.data;this.debug(`<<< ${s}`)}e.parseChunk(t.data,this.appendMissingNULLonIncoming)},this._webSocket.onclose=t=>{this.debug(`Connection closed to ${this._webSocket.url}`),this._cleanUp(),this.onWebSocketClose(t)},this._webSocket.onerror=t=>{this.onWebSocketError(t)},this._webSocket.onopen=()=>{const t=Object.assign({},this.connectHeaders);this.debug("Web Socket Opened..."),t["accept-version"]=this.stompVersions.supportedVersions(),t["heart-beat"]=[this.heartbeatOutgoing,this.heartbeatIncoming].join(","),this._transmit({command:"CONNECT",headers:t})}}_setupHeartbeat(e){if(e.version!==p.V1_1&&e.version!==p.V1_2||!e["heart-beat"])return;const[t,s]=e["heart-beat"].split(",").map(o=>parseInt(o,10));if(this.heartbeatOutgoing!==0&&s!==0){const o=Math.max(this.heartbeatOutgoing,s);this.debug(`send PING every ${o}ms`),this._pinger=new Ce(o,this._client.heartbeatStrategy,this.debug),this._pinger.start(()=>{this._webSocket.readyState===C.OPEN&&(this._webSocket.send(I.LF),this.debug(">>> PING"))})}if(this.heartbeatIncoming!==0&&t!==0){const o=Math.max(this.heartbeatIncoming,t);this.debug(`check PONG every ${o}ms`),this._ponger=setInterval(()=>{const r=Date.now()-this._lastServerActivityTS;r>o*2&&(this.debug(`did not receive server activity for the last ${r}ms`),this._closeOrDiscardWebsocket())},o)}}_closeOrDiscardWebsocket(){this.discardWebsocketOnCommFailure?(this.debug("Discarding websocket, the underlying socket may linger for a while"),this.discardWebsocket()):(this.debug("Issuing close on the websocket"),this._closeWebsocket())}forceDisconnect(){this._webSocket&&(this._webSocket.readyState===C.CONNECTING||this._webSocket.readyState===C.OPEN)&&this._closeOrDiscardWebsocket()}_closeWebsocket(){this._webSocket.onmessage=()=>{},this._webSocket.close()}discardWebsocket(){typeof this._webSocket.terminate!="function"&&we(this._webSocket,e=>this.debug(e)),this._webSocket.terminate()}_transmit(e){const{command:t,headers:s,body:o,binaryBody:r,skipContentLengthHeader:l}=e,c=new S({command:t,headers:s,body:o,binaryBody:r,escapeHeaderValues:this._escapeHeaderValues,skipContentLengthHeader:l});let h=c.serialize();if(this.logRawCommunication?this.debug(`>>> ${h}`):this.debug(`>>> ${c}`),this.forceBinaryWSFrames&&typeof h=="string"&&(h=new TextEncoder().encode(h)),typeof h!="string"||!this.splitLargeFrames)this._webSocket.send(h);else{let m=h;for(;m.length>0;){const _=m.substring(0,this.maxWebSocketChunkSize);m=m.substring(this.maxWebSocketChunkSize),this._webSocket.send(_),this.debug(`chunk sent = ${_.length}, remaining = ${m.length}`)}}}dispose(){if(this.connected)try{const e=Object.assign({},this.disconnectHeaders);e.receipt||(e.receipt=`close-${this._counter++}`),this.watchForReceipt(e.receipt,t=>{this._closeWebsocket(),this._cleanUp(),this.onDisconnect(t)}),this._transmit({command:"DISCONNECT",headers:e})}catch(e){this.debug(`Ignoring error during disconnect ${e}`)}else(this._webSocket.readyState===C.CONNECTING||this._webSocket.readyState===C.OPEN)&&this._closeWebsocket()}_cleanUp(){this._connected=!1,this._pinger&&(this._pinger.stop(),this._pinger=void 0),this._ponger&&(clearInterval(this._ponger),this._ponger=void 0)}publish(e){const{destination:t,headers:s,body:o,binaryBody:r,skipContentLengthHeader:l}=e,c=Object.assign({destination:t},s);this._transmit({command:"SEND",headers:c,body:o,binaryBody:r,skipContentLengthHeader:l})}watchForReceipt(e,t){this._receiptWatchers[e]=t}subscribe(e,t,s={}){s=Object.assign({},s),s.id||(s.id=`sub-${this._counter++}`),s.destination=e,this._subscriptions[s.id]=t,this._transmit({command:"SUBSCRIBE",headers:s});const o=this;return{id:s.id,unsubscribe(r){return o.unsubscribe(s.id,r)}}}unsubscribe(e,t={}){t=Object.assign({},t),delete this._subscriptions[e],t.id=e,this._transmit({command:"UNSUBSCRIBE",headers:t})}begin(e){const t=e||`tx-${this._counter++}`;this._transmit({command:"BEGIN",headers:{transaction:t}});const s=this;return{id:t,commit(){s.commit(t)},abort(){s.abort(t)}}}commit(e){this._transmit({command:"COMMIT",headers:{transaction:e}})}abort(e){this._transmit({command:"ABORT",headers:{transaction:e}})}ack(e,t,s={}){s=Object.assign({},s),this._connectedVersion===p.V1_2?s.id=e:s["message-id"]=e,s.subscription=t,this._transmit({command:"ACK",headers:s})}nack(e,t,s={}){return s=Object.assign({},s),this._connectedVersion===p.V1_2?s.id=e:s["message-id"]=e,s.subscription=t,this._transmit({command:"NACK",headers:s})}}class Ee{get webSocket(){var e;return(e=this._stompHandler)==null?void 0:e._webSocket}get disconnectHeaders(){return this._disconnectHeaders}set disconnectHeaders(e){this._disconnectHeaders=e,this._stompHandler&&(this._stompHandler.disconnectHeaders=this._disconnectHeaders)}get connected(){return!!this._stompHandler&&this._stompHandler.connected}get connectedVersion(){return this._stompHandler?this._stompHandler.connectedVersion:void 0}get active(){return this.state===b.ACTIVE}_changeState(e){this.state=e,this.onChangeState(e)}constructor(e={}){this.stompVersions=p.default,this.connectionTimeout=0,this.reconnectDelay=5e3,this._nextReconnectDelay=0,this.maxReconnectDelay=15*60*1e3,this.reconnectTimeMode=V.LINEAR,this.heartbeatIncoming=1e4,this.heartbeatOutgoing=1e4,this.heartbeatStrategy=U.Interval,this.splitLargeFrames=!1,this.maxWebSocketChunkSize=8*1024,this.forceBinaryWSFrames=!1,this.appendMissingNULLonIncoming=!1,this.discardWebsocketOnCommFailure=!1,this.state=b.INACTIVE;const t=()=>{};this.debug=t,this.beforeConnect=t,this.onConnect=t,this.onDisconnect=t,this.onUnhandledMessage=t,this.onUnhandledReceipt=t,this.onUnhandledFrame=t,this.onStompError=t,this.onWebSocketClose=t,this.onWebSocketError=t,this.logRawCommunication=!1,this.onChangeState=t,this.connectHeaders={},this._disconnectHeaders={},this.configure(e)}configure(e){Object.assign(this,e),this.maxReconnectDelay>0&&this.maxReconnectDelay<this.reconnectDelay&&(this.debug(`Warning: maxReconnectDelay (${this.maxReconnectDelay}ms) is less than reconnectDelay (${this.reconnectDelay}ms). Using reconnectDelay as the maxReconnectDelay delay.`),this.maxReconnectDelay=this.reconnectDelay)}activate(){const e=()=>{if(this.active){this.debug("Already ACTIVE, ignoring request to activate");return}this._changeState(b.ACTIVE),this._nextReconnectDelay=this.reconnectDelay,this._connect()};this.state===b.DEACTIVATING?(this.debug("Waiting for deactivation to finish before activating"),this.deactivate().then(()=>{e()})):e()}async _connect(){if(await this.beforeConnect(this),this._stompHandler){this.debug("There is already a stompHandler, skipping the call to connect");return}if(!this.active){this.debug("Client has been marked inactive, will not attempt to connect");return}this.connectionTimeout>0&&(this._connectionWatcher&&clearTimeout(this._connectionWatcher),this._connectionWatcher=setTimeout(()=>{this.connected||(this.debug(`Connection not established in ${this.connectionTimeout}ms, closing socket`),this.forceDisconnect())},this.connectionTimeout)),this.debug("Opening Web Socket...");const e=this._createWebSocket();this._stompHandler=new He(this,e,{debug:this.debug,stompVersions:this.stompVersions,connectHeaders:this.connectHeaders,disconnectHeaders:this._disconnectHeaders,heartbeatIncoming:this.heartbeatIncoming,heartbeatOutgoing:this.heartbeatOutgoing,heartbeatStrategy:this.heartbeatStrategy,splitLargeFrames:this.splitLargeFrames,maxWebSocketChunkSize:this.maxWebSocketChunkSize,forceBinaryWSFrames:this.forceBinaryWSFrames,logRawCommunication:this.logRawCommunication,appendMissingNULLonIncoming:this.appendMissingNULLonIncoming,discardWebsocketOnCommFailure:this.discardWebsocketOnCommFailure,onConnect:t=>{if(this._connectionWatcher&&(clearTimeout(this._connectionWatcher),this._connectionWatcher=void 0),!this.active){this.debug("STOMP got connected while deactivate was issued, will disconnect now"),this._disposeStompHandler();return}this.onConnect(t)},onDisconnect:t=>{this.onDisconnect(t)},onStompError:t=>{this.onStompError(t)},onWebSocketClose:t=>{this._stompHandler=void 0,this.state===b.DEACTIVATING&&this._changeState(b.INACTIVE),this.onWebSocketClose(t),this.active&&this._schedule_reconnect()},onWebSocketError:t=>{this.onWebSocketError(t)},onUnhandledMessage:t=>{this.onUnhandledMessage(t)},onUnhandledReceipt:t=>{this.onUnhandledReceipt(t)},onUnhandledFrame:t=>{this.onUnhandledFrame(t)}}),this._stompHandler.start()}_createWebSocket(){let e;if(this.webSocketFactory)e=this.webSocketFactory();else if(this.brokerURL)e=new WebSocket(this.brokerURL,this.stompVersions.protocolVersions());else throw new Error("Either brokerURL or webSocketFactory must be provided");return e.binaryType="arraybuffer",e}_schedule_reconnect(){this._nextReconnectDelay>0&&(this.debug(`STOMP: scheduling reconnection in ${this._nextReconnectDelay}ms`),this._reconnector=setTimeout(()=>{this.reconnectTimeMode===V.EXPONENTIAL&&(this._nextReconnectDelay=this._nextReconnectDelay*2,this.maxReconnectDelay!==0&&(this._nextReconnectDelay=Math.min(this._nextReconnectDelay,this.maxReconnectDelay))),this._connect()},this._nextReconnectDelay))}async deactivate(e={}){var r;const t=e.force||!1,s=this.active;let o;if(this.state===b.INACTIVE)return this.debug("Already INACTIVE, nothing more to do"),Promise.resolve();if(this._changeState(b.DEACTIVATING),this._nextReconnectDelay=0,this._reconnector&&(clearTimeout(this._reconnector),this._reconnector=void 0),this._stompHandler&&this.webSocket.readyState!==C.CLOSED){const l=this._stompHandler.onWebSocketClose;o=new Promise((c,h)=>{this._stompHandler.onWebSocketClose=m=>{l(m),c()}})}else return this._changeState(b.INACTIVE),Promise.resolve();return t?(r=this._stompHandler)==null||r.discardWebsocket():s&&this._disposeStompHandler(),o}forceDisconnect(){this._stompHandler&&this._stompHandler.forceDisconnect()}_disposeStompHandler(){this._stompHandler&&this._stompHandler.dispose()}publish(e){this._checkConnection(),this._stompHandler.publish(e)}_checkConnection(){if(!this.connected)throw new TypeError("There is no underlying STOMP connection")}watchForReceipt(e,t){this._checkConnection(),this._stompHandler.watchForReceipt(e,t)}subscribe(e,t,s={}){return this._checkConnection(),this._stompHandler.subscribe(e,t,s)}unsubscribe(e,t={}){this._checkConnection(),this._stompHandler.unsubscribe(e,t)}begin(e){return this._checkConnection(),this._stompHandler.begin(e)}commit(e){this._checkConnection(),this._stompHandler.commit(e)}abort(e){this._checkConnection(),this._stompHandler.abort(e)}ack(e,t,s={}){this._checkConnection(),this._stompHandler.ack(e,t,s)}nack(e,t,s={}){this._checkConnection(),this._stompHandler.nack(e,t,s)}}const w=d(null),v=d(!1),T=d(!1),F=d(null),W=d(new Map);function De(){return{connected:v,connecting:T,error:F,connect:(r="/ws")=>{if(T.value||v.value){console.log("WebSocket already connected or connecting, skipping. connected:",v.value,"connecting:",T.value);return}T.value=!0,F.value=null;const c=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.hostname}:8097/performance${r}`;console.log("WebSocket connecting to:",c),w.value=new Ee({brokerURL:c,reconnectDelay:5e3,heartbeatIncoming:4e3,heartbeatOutgoing:4e3,onConnect:h=>{v.value=!0,T.value=!1,P(()=>{})},onDisconnect:h=>{console.log("WebSocket disconnected:",h),v.value=!1,T.value=!1},onStompError:h=>{console.error("STOMP error:",h),F.value=h.headers.message||"Connection error",T.value=!1}});try{w.value.activate()}catch(h){console.error("Failed to activate WebSocket:",h),F.value=h.message,T.value=!1}},disconnect:()=>{w.value&&v.value&&(W.value.forEach(r=>r.unsubscribe()),W.value.clear(),w.value.deactivate(),v.value=!1)},subscribe:(r,l)=>{if(!w.value)return console.error("WebSocket client not initialized"),null;if(!v.value)return console.warn(`WebSocket not connected when trying to subscribe to ${r}. connected.value = ${v.value}`),null;try{const c=w.value.subscribe(r,h=>{try{const m=JSON.parse(h.body);P(()=>{l(m)})}catch(m){console.error("Failed to parse message:",m),l(h.body)}});return W.value.set(r,c),c}catch(c){return console.error("Failed to subscribe:",c),null}},unsubscribe:r=>{const l=W.value.get(r);l&&(l.unsubscribe(),W.value.delete(r))},send:(r,l)=>{if(!w.value||!v.value)return console.warn("WebSocket not connected"),!1;try{return w.value.publish({destination:r,body:typeof l=="string"?l:JSON.stringify(l)}),!0}catch(c){return console.error("Failed to send message:",c),!1}}}}export{De as a,f as p,Ne as u};
