<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{dashboard/layout}">
<head>
  <!--
  실시간 모니터링 페이지
  WebSocket + Chart.js를 통한 실시간 메트릭 모니터링
  
  AIDEV-NOTE: 실시간 차트, 로그, 상태 업데이트 지원
  -->
  <title th:text="'실시간 모니터링 - ' + ${testId} + ' - Exam Center Dashboard'">실시간 모니터링</title>
</head>
<body>
  <!-- 페이지별 스타일 - Tailwind CSS로 대체 -->
  <th:block layout:fragment="styles">
  </th:block>

  <!-- 메인 콘텐츠 -->
  <div layout:fragment="content">
    <!-- 페이지 헤더 -->
    <div class="flex justify-between items-center mb-4">
      <div>
        <h1 class="text-2xl font-bold">실시간 모니터링</h1>
        <p class="text-gray-500">테스트 ID: <span class="font-mono font-semibold" th:text="${testId}">TestId_123</span></p>
      </div>
      <div class="flex gap-2">
        <a href="/performance/dashboard" class="btn btn-secondary btn-sm">
          <i class="fas fa-arrow-left"></i> 대시보드로
        </a>
        <button onclick="stopTest(testId)" class="btn btn-danger btn-sm">
          <i class="fas fa-stop"></i> 테스트 중단
        </button>
      </div>
    </div>

    <!-- 모니터링 메인 그리드 -->
    <div class="grid grid-cols-2 gap-6 mb-6">
      <!-- 차트 영역 -->
      <div class="charts-section">
        <div class="charts-grid">
          <!-- TPS 차트 -->
          <div class="chart-container">
            <div class="chart-title">TPS (초당 트랜잭션)</div>
            <div class="h-64"><canvas id="tps-chart" class="w-full"></canvas></div>
          </div>
          
          <!-- 응답시간 차트 -->
          <div class="chart-container">
            <div class="chart-title">응답시간 (ms)</div>
            <div class="h-64"><canvas id="response-time-chart" class="w-full"></canvas></div>
          </div>
          
          <!-- 활성 사용자 차트 -->
          <div class="chart-container">
            <div class="chart-title">활성 사용자 수</div>
            <div class="h-64"><canvas id="active-users-chart" class="w-full"></canvas></div>
          </div>
          
          <!-- 에러율 차트 -->
          <div class="chart-container">
            <div class="chart-title">에러율 (%)</div>
            <div class="h-64"><canvas id="error-rate-chart" class="w-full"></canvas></div>
          </div>
        </div>
      </div>

      <!-- 메트릭 패널 -->
      <div class="metrics-panel">
        <!-- 테스트 상태 -->
        <div class="bg-white border border-gray-200 p-4">
          <div class="status-header">
            <h3 class="status-title">테스트 상태</h3>
            <span id="test-status" class="inline-block px-3 py-1 bg-blue-100 text-blue-700 font-semibold">RUNNING</span>
          </div>
          
          <!-- 진행률 -->
          <div class="progress-section">
            <div class="progress-header">
              <span class="progress-label">진행률</span>
              <span id="test-progress-text" class="progress-percentage">0%</span>
            </div>
            <div  class="h-1.5 bg-gray-100 border border-gray-300">
              <div id="test-progress-bar" class="progress-bar-fill h-full bg-primary-600"></div>
            </div>
          </div>
          
          <!-- 현재 메트릭 -->
          <div class="current-status">
            <div class="status-item">
              <div id="tps-value" class="status-value">0</div>
              <div class="status-label">TPS</div>
            </div>
            <div class="status-item">
              <div id="response-time-value" class="status-value">0</div>
              <div class="status-label">응답시간(ms)</div>
            </div>
            <div class="status-item">
              <div id="active-users-value" class="status-value">0</div>
              <div class="status-label">활성사용자</div>
            </div>
            <div class="status-item">
              <div id="error-rate-value" class="status-value">0</div>
              <div class="status-label">에러율(%)</div>
            </div>
          </div>
        </div>

        <!-- 실시간 로그 -->
        <div class="bg-white border border-gray-200 p-4">
          <h3 class="status-title mb-3">실시간 로그</h3>
          <div id="log-container" class="h-64 overflow-y-auto bg-gray-50 p-3 font-mono text-sm">
            <div class="text-gray-500 text-center">로그 로딩 중...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 상태 메시지 영역 -->
    <div id="status-container"></div>
  </div>

  <!-- 페이지별 스크립트 -->
  <th:block layout:fragment="scripts">
    <script th:src="@{/js/monitor.js?v=1.1}"></script>
    
    <script th:inline="javascript">
      // 서버에서 전달된 테스트 ID
      const testId = /*[[${testId}]]*/ 'TestId_123';
      
      // 페이지 초기화
      function initializePage() {
        console.log('실시간 모니터링 페이지 초기화:', testId);
        
        // 모니터링 시작
        startMonitoring(testId).then(manager => {
          console.log('모니터링 시작 완료');
          window.monitoringManager = manager;
        }).catch(error => {
          console.error('모니터링 시작 실패:', error);
          showAlert('모니터링 초기화에 실패했습니다: ' + error.message, 'danger');
        });
      }
      
      // 테스트 중단 함수 (전역 노출)
      async function stopTest(testId) {
        if (window.stopTest) {
          await window.stopTest(testId);
        }
      }
      
      // 알림 표시 함수
      function showAlert(message, type = 'info') {
        const alertContainer = document.getElementById('status-container');
        if (!alertContainer) return;
        
        const alert = document.createElement('div');
        alert.className = `alert-custom alert-${type}`;
        alert.innerHTML = `
          <span>${message}</span>
          <button type="button" class="close" onclick="this.parentElement.remove()" class="float-right bg-transparent border-0 text-xl">&times;</button>
        `;
        
        alertContainer.appendChild(alert);
        
        // 5초 후 자동 제거
        setTimeout(() => {
          if (alert.parentElement) {
            alert.remove();
          }
        }, 5000);
      }
      
      // 페이지 언로드 시 정리
      window.addEventListener('beforeunload', function() {
        if (window.monitoringManager) {
          window.monitoringManager.stopMonitoring();
        }
      });
    </script>
  </th:block>
</body>
</html>