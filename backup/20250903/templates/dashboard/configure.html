<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{dashboard/layout}">
<head>
  <!--
  테스트 설정 페이지
  테스트 파라미터 설정 및 실행
  
  AIDEV-NOTE: 폼 유효성 검사, 실시간 설정 미리보기 지원
  -->
  <title>테스트 설정 - Exam Center Dashboard</title>
</head>
<body>
  <!-- 페이지별 스타일 - Tailwind CSS로 대체 -->
  <th:block layout:fragment="styles">
  </th:block>

  <!-- 메인 콘텐츠 -->
  <div layout:fragment="content">
    <!-- 페이지 헤더 -->
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">성능 테스트 설정</h1>
      <div class="flex gap-2">
        <a href="/dashboard" class="btn btn-secondary btn-sm">
          <i class="fas fa-arrow-left"></i> 대시보드로
        </a>
      </div>
    </div>

    <!-- 테스트 설정 폼 -->
    <form id="test-config-form" class="max-w-4xl mx-auto" th:object="${testRequest}">
      <!-- 기본 설정 -->
      <div class="bg-white border border-gray-200 p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fas fa-cogs"></i>
          기본 설정
        </h3>
        
        <div class="mb-4">
          <label for="planId" class="block text-sm font-medium text-gray-700 mb-2">시험 계획 *</label>
          <select id="planId" name="planId" class="w-full border border-gray-300 px-3 py-2" th:field="*{planId}" required>
            <option value="">시험 계획을 선택하세요</option>
            <option th:each="plan : ${examPlans}" 
                    th:value="${plan.planId}" 
                    th:text="${plan.planId + ' - ' + plan.name}"
                    th:selected="${selectedPlan != null and selectedPlan.planId == plan.planId}">
              1 - 시험 계획명
            </option>
          </select>
          <div class="text-xs text-gray-500 mt-1">성능 테스트를 실행할 시험 계획을 선택하세요.</div>
        </div>
        
        <div class="mb-4">
          <label for="runType" class="block text-sm font-medium text-gray-700 mb-2">실행 타입 *</label>
          <select id="runType" name="runType" class="w-full border border-gray-300 px-3 py-2" th:field="*{runType}" required>
            <option th:each="runType : ${runTypes}" 
                    th:value="${runType.value}" 
                    th:text="${runType.label}">TEST</option>
          </select>
          <div class="text-xs text-gray-500 mt-1">테스트 환경 타입을 선택하세요.</div>
        </div>
        
        <div class="mb-4">
          <label for="testName" class="block text-sm font-medium text-gray-700 mb-2">테스트 이름 (선택)</label>
          <input type="text" id="testName" name="testName" class="w-full border border-gray-300 px-3 py-2" 
                 th:field="*{testName}" placeholder="예: 정기시험_부하테스트_2025">
          <div class="text-xs text-gray-500 mt-1">식별하기 쉬운 테스트 이름을 입력하세요.</div>
        </div>
      </div>

      <!-- 부하 설정 -->
      <div class="bg-white border border-gray-200 p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fas fa-users"></i>
          부하 설정
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="">
            <div class="mb-4">
              <label for="maxUsers" class="block text-sm font-medium text-gray-700 mb-2">최대 사용자 수 *</label>
              <input type="number" id="maxUsers" name="maxUsers" class="w-full border border-gray-300 px-3 py-2" 
                     th:field="*{maxUsers}" min="1" max="10000" step="1" required>
              <div class="text-xs text-gray-500 mt-1">동시 접속할 최대 사용자 수</div>
            </div>
          </div>
          
          <div class="">
            <div class="mb-4">
              <label for="rampUpSeconds" class="block text-sm font-medium text-gray-700 mb-2">램프업 시간 (초) *</label>
              <input type="number" id="rampUpSeconds" name="rampUpSeconds" class="w-full border border-gray-300 px-3 py-2" 
                     th:field="*{rampUpSeconds}" min="0" max="3600" step="1" required>
              <div class="text-xs text-gray-500 mt-1">최대 사용자까지 도달하는 시간</div>
            </div>
          </div>
          
          <div class="">
            <div class="mb-4">
              <label for="testDurationSeconds" class="block text-sm font-medium text-gray-700 mb-2">테스트 지속시간 (초) *</label>
              <input type="number" id="testDurationSeconds" name="testDurationSeconds" class="w-full border border-gray-300 px-3 py-2" 
                     th:field="*{testDurationSeconds}" min="60" max="7200" step="1" required>
              <div class="text-xs text-gray-500 mt-1">테스트를 실행할 총 시간</div>
            </div>
          </div>
        </div>
        
        <!-- 설정 미리보기 -->
        <div class="bg-gray-50 border border-gray-200 p-4 mt-4">
          <h5 class="mb-3">설정 미리보기</h5>
          <div class="flex justify-between items-center py-2 border-b border-gray-200 last:border-0">
            <span class="text-sm text-gray-600">예상 최대 부하</span>
            <span class="font-semibold text-gray-900" id="preview-max-load">100 TPS</span>
          </div>
          <div class="flex justify-between items-center py-2 border-b border-gray-200 last:border-0">
            <span class="text-sm text-gray-600">총 예상 요청 수</span>
            <span class="font-semibold text-gray-900" id="preview-total-requests">30,000 requests</span>
          </div>
          <div class="flex justify-between items-center py-2 border-b border-gray-200 last:border-0">
            <span class="text-sm text-gray-600">예상 소요 시간</span>
            <span class="font-semibold text-gray-900" id="preview-duration">8분 20초</span>
          </div>
        </div>
      </div>

      <!-- 시나리오 선택 -->
      <div class="bg-white border border-gray-200 p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fas fa-route"></i>
          테스트 시나리오
        </h3>
        
        <div class="space-y-3">
          <div th:each="scenario : ${scenarios}" class="border border-gray-200 p-4 hover:border-indigo-300 cursor-pointer" 
               th:classappend="${testRequest.scenario == scenario.value} ? 'selected' : ''">
            <label>
              <input type="radio" name="scenario" th:value="${scenario.value}" 
                     th:field="*{scenario}" th:checked="${testRequest.scenario == scenario.value}">
              <div class="font-medium text-gray-900" th:text="${scenario.label}">시나리오명</div>
              <div class="text-sm text-gray-500 mt-1" th:text="${scenario.description}">시나리오 설명</div>
            </label>
          </div>
        </div>
      </div>

      <!-- 고급 설정 (접기/펼치기) -->
      <div class="bg-white border border-gray-200 p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fas fa-cog"></i>
          고급 설정
        </h3>
        
        <div id="advanced-settings">
          <div class="mb-4">
            <label for="additionalConfig" class="block text-sm font-medium text-gray-700 mb-2">추가 설정 (JSON)</label>
            <textarea id="additionalConfig" name="additionalConfig" class="w-full border border-gray-300 px-3 py-2" rows="4" 
                      th:field="*{additionalConfig}" 
                      placeholder='{"timeout": 30000, "retries": 3}'></textarea>
            <div class="text-xs text-gray-500 mt-1">JSON 형태로 추가 설정을 입력하세요. (선택사항)</div>
          </div>
        </div>
      </div>

      <!-- 실행 버튼 -->
      <div class="mt-8 text-center">
        <div class="flex justify-center gap-3">
          <button type="button" class="btn btn-secondary btn-sm" onclick="saveAsTemplate()">
            <i class="fas fa-save"></i> 템플릿 저장
          </button>
          <button type="submit" class="btn btn-primary btn-sm" id="start-test-btn">
            <i class="fas fa-play"></i> 테스트 시작
          </button>
        </div>
        
        <div id="form-message" class="mt-3 hidden"></div>
        
        <div class="mt-4 text-muted">
          <small>
            <i class="fas fa-info-circle"></i>
            테스트 시작 후 실시간 모니터링 페이지로 자동 이동됩니다.
          </small>
        </div>
      </div>
    </form>
  </div>

  <!-- 페이지별 스크립트 -->
  <th:block layout:fragment="scripts">
    <script>
      // 페이지 초기화
      function initializePage() {
        console.log('테스트 설정 페이지 초기화');
        
        // 폼 이벤트 리스너
        setupFormListeners();
        
        // 초기 미리보기 업데이트
        updatePreview();
      }
      
      // 폼 이벤트 리스너 설정
      function setupFormListeners() {
        const form = document.getElementById('test-config-form');
        const inputs = form.querySelectorAll('input[type="number"]');
        
        // 숫자 입력 필드 변경 시 미리보기 업데이트
        inputs.forEach(input => {
          input.addEventListener('input', updatePreview);
          input.addEventListener('change', updatePreview);
        });
        
        // 라디오 버튼 시각적 효과
        const radioOptions = document.querySelectorAll('.radio-option');
        radioOptions.forEach(option => {
          const radio = option.querySelector('input[type="radio"]');
          
          option.addEventListener('click', function() {
            // 모든 옵션에서 selected 클래스 제거
            radioOptions.forEach(opt => opt.classList.remove('selected'));
            // 현재 옵션에 selected 클래스 추가
            this.classList.add('selected');
            radio.checked = true;
          });
        });
        
        // 폼 제출 처리
        form.addEventListener('submit', handleFormSubmit);
      }
      
      // 미리보기 업데이트
      function updatePreview() {
        const maxUsers = parseInt(document.getElementById('maxUsers').value) || 0;
        const rampUpSeconds = parseInt(document.getElementById('rampUpSeconds').value) || 0;
        const testDurationSeconds = parseInt(document.getElementById('testDurationSeconds').value) || 0;
        
        // 예상 최대 부하 계산 (간단한 추정)
        const maxLoad = Math.round(maxUsers * 0.5); // 사용자당 0.5 TPS 가정
        document.getElementById('preview-max-load').textContent = maxLoad + ' TPS';
        
        // 총 예상 요청 수 계산
        const avgTps = maxLoad * 0.7; // 평균 70% 부하 가정
        const totalRequests = Math.round(avgTps * testDurationSeconds);
        document.getElementById('preview-total-requests').textContent = totalRequests.toLocaleString() + ' requests';
        
        // 예상 소요 시간
        const totalSeconds = rampUpSeconds + testDurationSeconds;
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        document.getElementById('preview-duration').textContent = minutes + '분 ' + seconds + '초';
      }
      
      // 폼 제출 처리
      async function handleFormSubmit(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const submitBtn = document.getElementById('start-test-btn');
        const messageDiv = document.getElementById('form-message');
        
        // 버튼 비활성화
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 테스트 시작 중...';
        
        try {
          // 폼 데이터를 JSON으로 변환
          const testRequest = {
            planId: parseInt(formData.get('planId')),
            runType: formData.get('runType'),
            maxUsers: parseInt(formData.get('maxUsers')),
            rampUpSeconds: parseInt(formData.get('rampUpSeconds')),
            testDurationSeconds: parseInt(formData.get('testDurationSeconds')),
            scenario: formData.get('scenario'),
            testName: formData.get('testName'),
            additionalConfig: formData.get('additionalConfig')
          };
          
          // API 호출 (getApiUrl 함수 사용)
          const response = await fetch(getApiUrl('/api/dashboard/tests/start'), {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(testRequest)
          });
          
          const result = await response.json();
          
          if (result.success) {
            // 성공 메시지 표시
            showMessage('테스트가 성공적으로 시작되었습니다!', 'success');
            
            // 2초 후 모니터링 페이지로 이동
            setTimeout(() => {
              const contextPath = window.location.pathname.split('/')[1] || '';
              const monitorUrl = contextPath ? `/${contextPath}/dashboard/monitor/${result.data.testId}` : `/dashboard/monitor/${result.data.testId}`;
              window.location.href = monitorUrl;
            }, 2000);
            
          } else {
            // 오류 메시지 표시
            showMessage(result.message || '테스트 시작에 실패했습니다.', 'error');
            resetSubmitButton();
          }
          
        } catch (error) {
          console.error('테스트 시작 오류:', error);
          showMessage('테스트 시작 중 오류가 발생했습니다.', 'error');
          resetSubmitButton();
        }
      }
      
      // 제출 버튼 리셋
      function resetSubmitButton() {
        const submitBtn = document.getElementById('start-test-btn');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-play"></i> 테스트 시작';
      }
      
      // 메시지 표시
      function showMessage(message, type) {
        const messageDiv = document.getElementById('form-message');
        messageDiv.className = type === 'success' ? 'bg-green-100 text-green-700 p-3 border border-green-300' : 'bg-red-100 text-red-700 p-3 border border-red-300';
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';
        
        // 5초 후 자동 숨김
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 5000);
      }
      
      // 템플릿 저장
      function saveAsTemplate() {
        // 현재 폼 데이터 수집
        const templateData = {
          templateName: prompt('템플릿 이름을 입력하세요:'),
          planId: $('#planId').val(),
          runType: $('#runType').val(),
          maxUsers: $('#maxUsers').val(),
          rampUpSeconds: $('#rampUpSeconds').val(),
          testDurationSeconds: $('#testDurationSeconds').val(),
          scenario: $('#scenario').val(),
          targetUrl: $('#targetUrl').val()
        };
        
        if (!templateData.templateName) {
          return;
        }
        
        // 로컬 스토리지에 템플릿 저장
        let templates = JSON.parse(localStorage.getItem('performanceTestTemplates') || '[]');
        
        // 중복 체크
        const existingIndex = templates.findIndex(t => t.templateName === templateData.templateName);
        if (existingIndex >= 0) {
          if (!confirm('같은 이름의 템플릿이 있습니다. 덮어쓰시겠습니까?')) {
            return;
          }
          templates[existingIndex] = {
            ...templateData,
            updatedAt: new Date().toISOString()
          };
        } else {
          templates.push({
            ...templateData,
            createdAt: new Date().toISOString()
          });
        }
        
        localStorage.setItem('performanceTestTemplates', JSON.stringify(templates));
        
        // 성공 메시지 표시
        const alertHtml = `
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> 템플릿이 저장되었습니다: ${templateData.templateName}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `;
        
        $('#alert-container').append(alertHtml);
        
        // 5초 후 자동 제거
        setTimeout(function() {
          $('.alert').fadeOut('slow', function() {
            $(this).remove();
          });
        }, 5000);
      }
    </script>
  </th:block>
</body>
</html>